using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using MindFit_Intelligence_Backend.DTOs.Cuota;
using MindFit_Intelligence_Backend.Services.Interfaces;

namespace MindFit_Intelligence_Backend.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class CuotaController : ControllerBase
    {
        private readonly ICuotaService _cuotaService;

        public CuotaController(ICuotaService cuotaService)
        {
            _cuotaService = cuotaService;
        }

        // Front: Obtener historial de cuotas de un socio
        [Authorize]
        [HttpGet("socio/{idUsuario}")]
        public async Task<ActionResult<IEnumerable<CuotaDto>>> GetBySocio(int idUsuario)
        {
            IEnumerable<CuotaDto> cuotas = await _cuotaService.GetBySocio(idUsuario);
            return Ok(cuotas);
        }

        // Front: Obtener detalle de una cuota
        [Authorize]
        [HttpGet("{id}")]
        public async Task<ActionResult<CuotaDto>> GetById(int id)
        {
            CuotaDto? cuotaDto = await _cuotaService.GetById(id);
            return cuotaDto == null ? NotFound() : Ok(cuotaDto);
        }

        // Front: Registrar nueva cuota (renovación de plan)
        [Authorize(Policy = "EditarUsuario")] // Cambiar a una política más específica
        [HttpPost]
        public async Task<ActionResult<CuotaDto>> Add(CuotaInsertDto dto)
        {
            // Usar FluentValidation Y NO Validation Pattern para validacion de campos de fomulario
            if (!_cuotaService.Validate(dto))
                return Conflict(_cuotaService.Errors);

            CuotaDto? cuotaDto = await _cuotaService.Add(dto);
            return CreatedAtAction(nameof(GetById), new { id = cuotaDto!.IdCuota }, cuotaDto);
        }

        // Front: Actualizar cuota (marcar como pagada, corregir monto, etc.)
        [Authorize(Policy = "EditarUsuario")] // Cambiar a una política más específica
        [HttpPut("{id}")]
        public async Task<ActionResult<CuotaDto>> Update(int id, CuotaUpdateDto dto)
        {
            CuotaDto? cuotaDto = await _cuotaService.Update(id, dto);
            return cuotaDto == null ? NotFound() : Ok(cuotaDto);
        }

        // Front: Eliminar cuota
        [Authorize(Policy = "EliminarUsuario")] // Cambiar a una política más específica
        [HttpDelete("{id}")]
        public async Task<ActionResult<CuotaDto>> Delete(int id)
        {
            CuotaDto? cuotaDto = await _cuotaService.Delete(id);
            return cuotaDto == null ? NotFound() : Ok(cuotaDto);
        }
    }
}
